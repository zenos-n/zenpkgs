name: ZenPkgs Integrity Check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  sanity-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Run Integrity Audit
        run: |
          # Evaluate the report and capture the output
          nix eval --json --file tests/integrity.nix report > report.json

          # Print the report for debugging
          cat report.json | jq .

          # Check status and fail if not PASSED
          STATUS=$(jq -r '.status' report.json)
          if [ "$STATUS" != "PASSED" ]; then
            echo "::error::Integrity Check Failed!"
            exit 1
          else
            echo "::notice::Integrity Check Passed"
          fi
