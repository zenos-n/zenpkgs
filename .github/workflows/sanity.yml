name: ZenPkgs Integrity Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sanity-check:
    name: Sanity Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Run Integrity Audit
        run: |
          # 1. Run the evaluation and save JSON output
          # We use --show-trace to help debug if Nix itself crashes
          nix eval --json --show-trace --file tests/integrity.nix report > report.json

          # 2. Print the full report to the build log for inspection
          echo "--- Audit Report ---"
          cat report.json | jq .

          # 3. Parse Status
          STATUS=$(jq -r '.status' report.json)

          # 4. Fail or Pass based on Status
          if [ "$STATUS" == "PASSED" ]; then
            echo "✅ Integrity Check Passed"
            exit 0
          else
            echo "❌ Integrity Check Failed"
            echo "::error::Integrity check returned status: $STATUS. Check logs for specific module/package errors."
            exit 1
          fi
