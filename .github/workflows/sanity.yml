name: Nix Integrity Check & Archive

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  check-integrity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Eval Report and Verify Status
        id: eval
        run: |
          # Run the evaluation and capture stdout
          # We use --json to ensure the output is strictly formatted for the file
          # But for the status check, we grep the raw eval

          echo "Running Integrity Check..."
          OUTPUT=$(nix eval --show-trace --file tests/integrity.nix report 2>&1)

          echo "Nix Evaluation Output:"
          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -Fq 'status = "PASSED";'; then
            echo "✅ Integrity check PASSED."
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ Integrity check FAILED."
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate Documentation JSON
        if: steps.eval.outputs.status == 'success' && github.event_name == 'push'
        id: docgen
        run: |
          # Generate the documentation JSON using the updated generator
          # We redirect to a temporary file first
          nix eval --json --file scripts/gen-docs.nix > docs.json

      - name: Archive JSON to 'json' branch
        if: steps.eval.outputs.status == 'success' && github.event_name == 'push'
        run: |
          # Configure Git Identity
          git config --global user.name "ZenOS Bot"
          git config --global user.email "bot@zenos.dev"

          # Stash the generated JSON so it survives the checkout
          mv docs.json /tmp/latestCommit.json

          # Fetch or Create 'json' branch
          git fetch origin json || true

          if git rev-parse --verify origin/json >/dev/null 2>&1; then
            git checkout json
          else
            # Create orphan branch if it doesn't exist
            git checkout --orphan json
            git rm -rf .
          fi

          # Restore the JSON
          mv /tmp/latestCommit.json latestCommit.json

          # Add, Commit, Push
          git add latestCommit.json
          git commit -m "Archive: ${GITHUB_SHA::7} - $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push origin json
