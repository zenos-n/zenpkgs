name: ZenPkgs Integrity Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sanity-check:
    name: Sanity Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Run Integrity Audit
        run: |
          echo "::group::Audit Execution"
          echo "Starting Integrity Audit..."

          # 1. Run eval with -v (verbose) to see download progress
          # Pipe to 'tee' so we see output in logs AND save to file
          # 2>&1 redirects stderr (traces) to stdout so they are captured/printed together
          nix eval --json --show-trace -v --file tests/integrity.nix report | tee report.json

          echo "::endgroup::"

          # 2. Check if report was generated
          if [ ! -s report.json ]; then
             echo "::error::Report file is empty. Evaluation likely crashed."
             exit 1
          fi

          # 3. Pretty print for logs
          echo "::group::Audit Results"
          jq . report.json
          echo "::endgroup::"

          # 4. Parse Status
          STATUS=$(jq -r '.status' report.json)

          # 5. Fail or Pass
          if [ "$STATUS" == "PASSED" ]; then
            echo "✅ Integrity Check Passed"
            exit 0
          else
            echo "❌ Integrity Check Failed"
            echo "::error::Integrity check returned status: $STATUS. Check logs for specific errors."
            exit 1
          fi
