name: ZenPkgs Integrity Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sanity-check:
    name: Sanity Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Runner
        run: echo "✅ Runner started! Installing Nix..."

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Run Integrity Audit
        run: |
          echo "::group::Audit Execution"
          echo "Starting Nix Evaluation..."

          # Run eval with trace and pipe to tee
          nix eval --json --show-trace -v --file tests/integrity.nix report | tee report.json

          echo "::endgroup::"

          if [ ! -s report.json ]; then
             echo "::error::Report file is empty. Evaluation likely crashed or produced no output."
             exit 1
          fi

          echo "::group::Audit Results"
          jq . report.json
          echo "::endgroup::"

          STATUS=$(jq -r '.status' report.json)

          if [ "$STATUS" == "PASSED" ]; then
            echo "✅ Integrity Check Passed"
            exit 0
          else
            echo "❌ Integrity Check Failed"
            echo "::error::Status: $STATUS. See logs for details."
            exit 1
          fi
